# å·¥ä½œæµåç§°
name: Release Lazy CLI

# è§¦å‘æ¡ä»¶
on:
  push:
    tags:
      - 'v*.*.*'
  # å…è®¸sä» "Actions" æ ‡ç­¾é¡µæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  # æ„å»ºå¹¶å‘å¸ƒ
  build-release:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        
    # æŒ‡å®šè¿è¡Œå™¨
    runs-on: ${{ matrix.os }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller  # å®‰è£…æ‰“åŒ…å·¥å…·
          pip install .            # å®‰è£… 'lazy' é¡¹ç›®æœ¬èº«åŠå…¶æ‰€æœ‰ä¾èµ–

      - name: Set platform-specific variables
        id: vars
        run: |
          if [ "${{ runner.os }}" == "Linux" ]; then
            # Linux ä¸“å±çš„ hidden imports
            echo "HIDDEN_IMPORTS=--hidden-import=keyring.backends.SecretService --hidden-import=keyring.backends.chainer" >> $GITHUB_ENV
            echo "ASSET_NAME=lazy-linux.tar.gz" >> $GITHUB_ENV
            echo "EXE_PATH=dist/lazy" >> $GITHUB_ENV
          elif [ "${{ runner.os }}" == "macOS" ]; then
            # macOS ä¸“å±çš„ hidden imports
            echo "HIDDEN_IMPORTS=--hidden-import=keyring.backends.macOS.Keyring" >> $GITHUB_ENV
            echo "ASSET_NAME=lazy-macos.tar.gz" >> $GITHUB_ENV
            echo "EXE_PATH=dist/lazy" >> $GITHUB_ENV
          elif [ "${{ runner.os }}" == "Windows" ]; then
            # Windows ä¸“å±çš„ hidden imports
            echo "HIDDEN_IMPORTS=--hidden-import=keyring.backends.Windows.WinVaultKeyring" >> $GITHUB_ENV
            echo "ASSET_NAME=lazy-windows.zip" >> $GITHUB_ENV
            echo "EXE_PATH=dist/lazy.exe" >> $GITHUB_ENV
          fi

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile --name lazy \
            src/lazy_cli_main.py \
            --add-data "data:data" \
            ${{ env.HIDDEN_IMPORTS }}

      - name: Archive the executable
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            powershell Compress-Archive -Path ${{ env.EXE_PATH }} -DestinationPath ${{ env.ASSET_NAME }}
          else
            # ä½¿ç”¨ tar -C æ¥é¿å…åœ¨å‹ç¼©åŒ…ä¸­åŒ…å« 'dist/' ç›®å½•ç»“æ„
            tar -czvf ${{ env.ASSET_NAME }} -C dist lazy
          fi

      - name: ğŸš€ Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}